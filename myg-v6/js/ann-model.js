// ===========================================================================
// 定义计算神经网络的函数
function eval_ann(ann_input, years){
  // 根据3年或5年，输入神经网络参数
  let ann_layer_1 = years === 5 ? ann_layer_1_5years : ann_layer_1_3years;
  let ann_layer_2 = years === 5 ? ann_layer_2_5years : ann_layer_2_3years;
  let ann_layer_3 = years === 5 ? ann_layer_3_5years : ann_layer_3_3years;

  // 当输入不全时，返回 null
  for (let i=0; i<ann_input.length; i++){
    if (typeof(ann_input[i])=="undefined"||ann_input[i]==''){
      return null
    }
  }

  // 计算神经网络，输入数据标准化
  let standard_input = math.dotDivide(math.subtract(ann_input,data_mean),data_std);
  // standard_input = LogisticSigmoid(standard_input);  // 使用 LogisticSigmoid 处理输入
  standard_input.push([1]);

  // 输入不做标准化，也不使用 LogisticSigmoid 处理
  // standard_input = ann_input;	// 向量
  // standard_input.push([1]);		// 增补末尾的 1

  // 计算神经网络，隐藏层1
  let ann_layer_1_out = math.multiply(ann_layer_1,standard_input);	// 输入→输出
  ann_layer_1_out.pop();										// 去掉末尾的 1
  ann_layer_1_out = Ramp(ann_layer_1_out);						// 使用激活函数
  ann_layer_1_out.push([1]);									// 增补末尾的 1，得到最终输出

  // 计算神经网络，隐藏层2
  let ann_layer_2_out = math.multiply(ann_layer_2,ann_layer_1_out);	// 输入→输出
  ann_layer_2_out.pop();										// 去掉末尾的 1
  ann_layer_2_out = Ramp(ann_layer_2_out);						// 使用激活函数
  ann_layer_2_out.push([1]);									// 增补末尾的 1，得到最终输出

  // 计算神经网络，隐藏层3
  let ann_layer_3_out = math.multiply(ann_layer_3,ann_layer_2_out);
  ann_layer_3_out.pop();

  // 计算神经网络，输出层
  let sm = SoftMax2(ann_layer_3_out);

  // 返回结果，阴性概率
  return sm[0]  // [阴性概率，阳性概率，这与训练模型中定义有关："output" -> NetDecoder[{"Class", {0, 1}}]]
}


// ===========================================================================
// 定义常用的激活函数（有些可能未被使用）
// 激活函数（Activation Function）LogisticSigmoid
function LogisticSigmoid(x_matrix){
  return math.dotDivide(1,math.add(1,math.exp(math.unaryMinus(x_matrix))))
}
// console.log(LogisticSigmoid([1,2,3]));

// 激活函数（Activation Function）Ramp
function Ramp(x_matrix){
  const a = math.matrix(x_matrix);
  const b = a.map(function (value, index, matrix) {
    return Math.max(0,value)
  });
  return b["_data"];
}

// 激活函数（Activation Function）SoftMax
function SoftMax(x_matrix){
  x = math.flatten(x_matrix);
  return math.divide(math.exp(x),math.multiply(math.ones(math.size(x)),math.exp(x)))
}
// console.log(SoftMax([1,2,3]));

// 激活函数（Activation Function）SoftMax2 (仅适用于2分类模型，即x_matrix为2行1列，解决大数计算问题)
function SoftMax2(x_matrix){
  x = math.flatten(x_matrix);
  return [1/(1+math.exp(x[1]-x[0])),1/(1+math.exp(x[0]-x[1]))]  // [阴性概率，阳性概率，这与训练模型中定义有关："output" -> NetDecoder[{"Class", {0, 1}}]]
}
// console.log(SoftMax2([1,2,3]));

// ===========================================================================
// const parser = math.parser()
// // 激活函数（Activation Function）
// parser.eval('LogisticSigmoid(x) = 1./(1.+e.^(-x))')
// console.log(parser.eval('LogisticSigmoid([1,2,3])'));
//
//
// // SoftMax
// parser.eval('SoftMax(x) = e.^(x)./(ones(size(x)[1])*(e.^(x)))')
// console.log(parser.eval('SoftMax([1,2,3])'));
// ===========================================================================


// 均值
let data_mean = [
[ 37.2468982630273000],
[ 0.0000000000000000],
[ 0.0000000000000000],
[ 0.0000000000000000],
[ 297.3740074441687000],
[ 162.6072661290323000],
[ 4.6187510402219150],
[ 168.0720872274143000],
[ 5.7235359801488840]
];

//标准差
let data_std = [
[ 10.6478457819398700],
[ 1.0000000000000000],
[ 1.0000000000000000],
[ 1.0000000000000000],
[ 387.5519075310841000],
[ 226.8939230923263000],
[ 1.2157919999849730],
[ 54.0670744054628100],
[ 1.8484033146817150]
];

//输入→隐藏层1，Weight+Biases
let ann_layer_1_5years = [
  [ 0.7728334069252014,-0.3362455070018768,-0.3458368778228760, 0.0838690921664238,-0.2046884745359421,-0.3196842074394226, 0.1820117235183716,-0.1588390618562698,-0.4265793561935425, 0.2262896001338959],
  [ 0.2104890048503876,-0.3530423641204834,-0.0145189026370645,-0.1057139784097672, 0.3873714506626129, 0.2619507014751434, 0.1011824086308479, 0.4608883857727051, 0.1336599439382553, 0.0409657955169678],
  [ 0.3113014400005341,-0.1598584949970245,-0.0330158434808254, 0.2381883263587952, 0.0302503723651171, 0.3484890758991241, 0.2889972925186157,-0.0760333612561226,-0.3009650707244873,-0.0283211153000593],
  [ 0.2490902841091156,-0.1329670101404190, 0.3608815968036652, 0.1913912296295166, 0.7753291726112366,-0.0315211638808250, 0.1166516095399857, 0.2204556614160538, 0.1981134116649628, 0.0995831117033958],
  [-0.2613751292228699,-0.2720425724983215, 0.3710787296295166, 0.0147029934450984,-0.4281477332115173,-0.4675615429878235, 0.1779506951570511,-0.5334167480468750, 0.9675242304801940, 0.2313563823699951],
  [-0.6202929019927979,-0.1835889667272568, 0.2116000056266785, 0.0999326631426811,-0.1647313982248306,-0.2842304110527039, 0.1217182204127312, 0.6021366119384766, 0.1078439429402351, 0.2736217975616455],
  [-0.0678636506199837,-0.2689457237720490, 0.0494987666606903,-0.2210526913404465, 0.0949635058641434, 0.2246313989162445,-0.1069176718592644, 0.2567694187164307,-0.4926401674747467, 0.1493783742189407],
  [ 0.6881963014602661, 0.8735154271125790,-0.0838107243180275, 0.2558254301548004,-0.1041863039135933,-0.7608358860015869, 0.3615806400775909, 0.0122769419103861,-0.1194103881716728, 0.2049499452114105],
  [ 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 1.0000000000000000]
];
let ann_layer_1_3years = [
  [ 0.1270316243171692, 0.0614138878881931,-0.0268452037125826, 0.0280791409313679,-0.0448747947812080,-0.1177123486995697, 0.0668543577194214,-0.0319005437195301,-0.0066652894020081, 0.0969848260283470],
  [ 0.0384697429835796,-0.0711818262934685, 0.0228080358356237, 0.0175100415945053, 0.2023602724075317, 0.0216771643608809, 0.0599350482225418, 0.1755701154470444, 0.0737337768077850, 0.0291415713727474],
  [ 0.3192605376243591,-0.2197152674198151, 0.0592535324394703, 0.0450030155479908, 0.1652713418006897, 0.2904508113861084,-0.0284577012062073, 0.0144255710765719,-0.3533718287944794, 0.0753767117857933],
  [-0.0005897493683733,-0.0782230868935585, 0.1994266360998154,-0.0599299892783165, 0.4517149925231934, 0.0291676074266434,-0.0593591853976250, 0.0471523441374302, 0.3644971251487732, 0.2767852842807770],
  [-0.2911984324455261,-0.1594406664371490, 0.1265427023172379,-0.0708707869052887,-0.0167962666600943,-0.3186341226100922,-0.0426717326045036,-0.1523649841547012, 0.5714169740676880, 0.0229074470698834],
  [-0.4307352304458618,-0.3691155612468720, 0.1970419585704803, 0.2438812404870987,-0.0956162139773369,-0.1633215844631195, 0.0608870163559914, 0.3776298165321350, 0.0333832651376724, 0.1767572611570358],
  [ 0.0441881529986858, 0.5471985936164856,-0.0011524208821356, 0.3926459848880768,-0.1753659695386887, 0.2316974252462387,-0.2538625299930573, 0.2476826757192612,-0.0321910455822945,-0.0379677191376686],
  [ 0.3496376574039459, 0.2555234730243683,-0.0714597478508949, 0.0718779340386391,-0.1156338229775429,-0.4332045316696167, 0.1840862184762955,-0.1005858927965164, 0.0520414598286152, 0.2555640935897827],
  [ 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 1.0000000000000000]
];

//输入→隐藏层2，Weight+Biases
let ann_layer_2_5years = [
  [-0.0188066400587559,-0.0269096847623587, 0.2919024527072906, 0.3894742131233215, 0.8041728734970090, 0.6502237319946289, 0.4557795226573944,-0.7070764899253845,-0.0005264908540994],
  [-0.4984919428825378, 0.3808721601963043, 0.5311645865440369, 0.8611091971397400, 0.8103103041648870, 0.5146190524101257, 0.2464576065540314,-0.2137317359447479, 0.0001283426681766],
  [ 0.7996750473976135, 0.3882449567317963, 0.4183354079723358,-0.1343996077775955,-0.6457410454750061, 0.0847001299262047, 0.4199364185333252,-0.5180147886276245, 0.0000047180510592],
  [-0.1057968363165855, 0.1590396016836166, 0.1204959303140640, 0.2251106500625610, 0.1944408714771271, 0.1486159861087799, 0.0716161653399468,-0.0810452401638031, 0.0004804894560948],
  [ 0.3921386599540710,-0.6693229675292969,-0.2137206792831421,-0.0778870433568955, 0.3561377227306366,-0.0264019370079041,-0.1388648897409439, 0.5899738669395447, 0.3471630513668060],
  [ 0.1180178672075272, 0.0610511712729931, 0.1025821268558502, 0.0754316374659538, 0.1765185594558716, 0.0903934836387634, 0.0268836263567209,-0.1042802408337593,-0.0016671067569405],
  [ 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 1.0000000000000000]
];
let ann_layer_2_3years = [
  [-0.0855855047702789, 0.1288374960422516, 0.5254705548286438, 0.4924997389316559, 0.5717664361000061, 0.5602526664733887,-0.4735004305839539,-0.2695735096931458, 0.3089056909084320],
  [-0.1073884218931198, 0.1359579265117645, 0.3041548430919647, 0.3520499765872955, 0.3675618469715118, 0.3780235350131989,-0.3195320963859558,-0.1516488492488861, 0.1966465115547180],
  [ 0.1594854593276978, 0.0763258114457130, 0.1991767436265945, 0.1948768496513367, 0.2140065878629684, 0.2169773429632187,-0.1797194033861160,-0.1648826003074646, 0.1100860536098480],
  [-0.0000899087972357, 0.0032318416051567,-0.0001855582231656,-0.0005654136184603,-0.0000467921818199,-0.0002932336938102,-0.0001591047039256,-0.0003242207167204,-0.0004429924883880],
  [ 0.2230245620012283,-0.2863177657127380,-0.2623789012432098,-0.2484004944562912,-0.2437851577997208,-0.3166178166866302, 0.5518633723258972, 0.6227750182151794, 0.3332775831222534],
  [ 0.0022669665049762, 0.0316710844635963, 0.0792485773563385, 0.0775695070624352, 0.0888548344373703, 0.0870914012193680,-0.0696689411997795,-0.0431301370263100, 0.0416205413639545],
  [ 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 1.0000000000000000]
];


//输入→隐藏层3，Weight+Biases
let ann_layer_3_5years = [
  [ 1.0686315298080440, 0.2281869500875473, 0.7492079734802246, 0.0280610639601946,-0.8338944315910340,-0.0713558867573738,-0.1834568828344345],
  [-0.7285005450248718,-1.2196605205535890,-0.5993361473083496,-0.4224697053432465, 0.1078554391860962,-0.2192679047584534, 0.1834567934274673],
  [ 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 1.0000000000000000]
];
let ann_layer_3_3years = [
  [ 0.8840583562850950, 0.4463828504085541, 0.3354537487030029,-0.0063262791372836,-0.8483082056045530, 0.1233940795063972,-0.1608234792947769],
  [-0.8533974885940550,-0.6649506092071533,-0.3339216411113739,-0.0000668578577461, 0.5135378241539001,-0.1405563354492187, 0.1608233302831650],
  [ 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 0.0000000000000000, 1.0000000000000000]
];

